<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Demonstrating the Word Association application</title>
<style type="text/css">
body
{
font-family:"sans-serif";
}
.instruction
{
font-style: italic;

}
p.dialogue
{
}
p.code
{
background-color:#e5e5e5;
font-family:"Courier", "monospace";
white-space:pre}
p.field
{
font-family:"Courier", "monospace";
}
p.command
{
font-family: "Courier", "monospace";
white-space: pre;
font-weight: bold;
}
p.xml
{
font-family:"Courier", "monospace";
color:green;
white-space:pre;
}
h2
{
color:white;
background-color:#003366;
}
</style>
</head>
<body>
<h1>Demonstrating the Word Association application</h1>
<p>
The Word Association application shows a very simple
example of a realistic
application architecture. The intention is that it can be coded up
from scratch in front of a live audience, rather than that it
demonstrate best practices or more complex patterns. A reference
copy of the finished application is included with these instructions.
</p>

<p>Things can go wrong in unexpected ways in live demos, so do have a
practice run before trying to write the wordassociation application
in front of other people. I've known of people who practice the live
coding parts of their demos twenty times before a presentation, although
that might be a bit too much preparation for most of us! The <a href="#troubleshooting">
troubleshooting tips</a> may help debug common problems. A working copy of the application is provided
for reference, so you can refer to it if things go slightly wrong, or swap
in pre-built bundles for broken bundles if things go very wrong.
</p>

<p>Italicized text is instructions to the person giving the demo. Most
of the rest of the text of this document is a sample script
for a demo.</p>

<h2>Pre-demo set-up</h2>
<h3>Assembly set-up</h3>

This should be done before starting the demo. Build the wordassociation.assembly
project using maven. The target directory provides an assembly into which the wordassociation
jars can be loaded and run.


<h3>IDE set-up</h3>

<h4>IBM Rational Tools for OSGi Applications</h4>
<p>The instructions assume the free version of the IBM Rational Tools for OSGi Applications are being used. The demo will work fine without them, but some of the steps 
for project creation and project export will be different. Follow these <a href="http://www.ibm.com/developerworks/rational/downloads/10/rationaldevtoolsforosgiapplications.html">instructions for 
installing the tools</a>.
</p>

<h3>OpenJPA</h3>

<p>
If you're running in a JEE-5-application server, JPA entities will be automatically enhanced. 
We're just running in a little OSGi container, so we need to do that ourselves. This
needs the full OpenJPA download. Download OpenJPA 2 from http://openjpa.apache.org/downloads.html.
(When I tried the binary download zip wouldn't unpack, so I had to download the source
distribution and build it.)
</p>

<p>Normally an ant task would be used to enhance the entities when building, 
but it can also be done 
 using
an eclipse builder. It's not possible to set up the builder in advance, but it is possible to create some
useful variables. 

</p>

<p class="instruction">In your workspace, select Window&rarr;Preferences and navigate to Run/Debug&rarr;
String substitution. Create two variables. Add a java_home variable which points to
your Java 6 installation, and open_jpa_home which points to the root of the OpenJPA download.
</p>

<h3>Database set-up</h3>

<p>This is also best done before starting the demo. The sql for the database is
in the root directory of the wordassociation sample. 
</p>

<p class="instruction">Run the following commands:
</p>

<p class="command">export CLASSPATH=$DERBY_INSTALL/lib/derby.jar:$DERBY_INSTALL/lib/derbytools.jar:.
java org.apache.derby.tools.ij createDB.sql
</p>

<p>The wordassociation.assembly includes a datasource bundle already.
This is a minor sleight-of-hand, but coding up the datasource
in front of a live audience and ensuring it loads before the
jpa bundle doesn't add much value pedagogically.
</p>

<p class="instruction">Add the datasource jar to the assembly and the config.ini
</p>

<p class="field">wordassociation.datasource_1.0.0.jar@start,\
</p>

<p>
If using a different assembly it's important that the datasource needs to be started before the rest of the application. 
</p>

<h3>Set-up verification</h3>

<p>
This demo involves a lot of live coding, so there is a possibility
of things going wrong. In the event of demo accidents, it may be best
to swap in the 'official' version of the problem jar. To confirm the
official versions will work, and verify the assembly is correct, copy
the *wordassociation* jars into the load directory of the wordassociation.assembly
directory. Confirm that <a href=http://localhost:8080/wordassociation.web/AssociateWord>http://localhost:8080/wordassociation.web/AssociateWord</a> 
URL works.
</p>


<p>Don't forget to remove the official jars before the demo starts - but do 
keep them somewhere handy for emergencies.</p>

<h2>The demo</h2>

<h3>Setting the scene</h3>

<p class="dialogue">We're going to write a web application which plays a game of 
word association with a user. The application has three components - there's a web
front end, a back end which handles the data and persistence using JPA. We want the 
front end and back end to be loosely coupled, so there's a third component which is 
a set of shared APIs.
</p>

<p class="instruction">It can be helpful to show the following architecture diagram:</p>

<img src="architecture.gif"></img>

<h4>The OSGi console</h4>
<p class="dialogue">
Before we do anything else, we're going to launch our OSGi container. 
</p>

<p class="command">
java -jar osgi-3.5.0.v20090520.jar -clean -console
</p>

<p class="dialogue">The command ss lists the currently installed bundles.
What we're running with here is a minimal set of bundles. We have an OSGi
container, which is just a few jars, and then we have some Apache Geronimo jars 
to give us the JEE services we're going to be using like JPA and JTA. Then we have Apache Aries sitting 
on top of the OSGi container. Aries can also sit on top of a full JEE server, and 
that's probably a more typical way of using it. </p>

<p>It should be possible to do the whole of the demo without restarting the OSGi console.</p> 

<h4>The IDE</h4>

<p class="dialogue">What we need to do now is create the bundles which make up our application.
A bundle is a jar which some extra-metadata, and so it's easy to create using your
favourite IDE. Eclipse has lots of OSGi support, and there's also a set of free tools
which have extra support for Aries, so I'll be using those, but all of this can easily
be done in another IDE, with base eclipse, or on the command line for the very hardcore.</p>


<p class="dialogue">We start off with a shared API. We want everything to be loosely coupled, so 
we'll have a bundle with interfaces. 
</p>

<p class="instruction">Right click, <b>New&rarr;Other&rarr;OSGi&rarr;OSGi Bundle project</b>.
Fill in the name wordassociation.api and click Finish. 
</p>

<p class="dialogue">We're going to play a game of word assocation,
so we need a service that gives us a word to associate with. 
</p>

<p class="instruction">Right click on the newly created project, do <b>New&rarr;Interface</b>, and 
</p>
<p style="field">
Package: org.apache.samples.wordassociation
Name: WordGetterService. 
</p>
Add the following method:

<p class="code">        public String getRandomWord();
</p>

<p class="dialogue">We'll also want to do some sort of analysis on what associations people make, so
 we'll add an association recorder service. 
</p>

<p class="instruction">
Right click on the newly created project, do <b>New&rarr;Interface</b>, and
</p>
<p style="field">
Package: org.apache.samples.wordassociation
Name: AssociationRecorderService.
</p>

<p class="instruction">Add the following method:
</p>
<p class="code">        public String recordAssociation(String word, String association);
</p>

<p class="dialogue">It's no use making a note of what associations have been made if we can't access
 that data, so we'll add one more method:</p>

<p class="code">        public String getLastAssociation(String word);
</p>

<p class="dialogue">The default in OSGi is for classes to be private to a bundle, but this is an API, so we 
declare that it's public. </p>

<p class="instruction">Double-click on the manifest, click on the runtime tab, and click Add.
Select the wordassociation package. Select manifest tab to show the change which has been made.</p>

<p class="dialogue">Making that package visible externally is just a question of adding a line in the bundle manifest. </p>

<h4>Export</h4>

<p class="instruction">Finish off by exporting the bundle. Right click on
the project, choose Export, and then navigate to OSGi&rarr;OSGi Bundle.
Choose the load directory of your assembly for the export location 
and click Finish. Go back to the OSGi console and type ss again.
The new bundle should have appeared in the framework. The GOAT
tool could also be used to show the bundle appearing.</p>

<h3>The web bundle</h3>

<p class="dialogue">Now that we have our interfaces for our services, 
we're going to create our web front-end.</p>
<p class="instruction">Make the project for the web front end. Right click, New&rarr;Other&rarr;OSGi&rarr;OSGi Bundle project.
Fill in the name wordassociation.web
Select 'OSGi Web Configuration' from the configuration drop-down.
Click Finish.
</p>

<p class="instruction">
Expand the Deployment Descriptor twistie.
</p>
<p class="instruction">Right-click on Servlets to create a new servlet. 
</p>
<p class="instruction">Enter the following.
</p>

<p class="field">
package name: org.apache.wordassociation.web
<br/>
class name: AssociateWord
</p>

<p class="dialogue">It will auto-create the servlet. </p>

<p class="dialogue">There will be compile errors.
This is the first point at which we're starting to see it's OSGi.
Normally, we'd have to change the eclipse classpath to add the javax.servlet jar. Well, that's actually the second step. First of all we'd have to work out what
 jar the HttpServlet class is in. 
 How many of you have got good at doing 'grep -r' on your system to figure out what jar a class is in? 
</p>

<p class="dialogue">In this case, we just declare that we're have a dependency on the javax.servlet 
and javax.servlet.http packages. To do that, we open our manifest and enter it as a dependency. Eclipse will even give us content completion, but we can also enter it by hand on the manifest
</p>
<p class="instruction">Expand WebContent&rarr;META-INF&rarr;MANIFEST.MF and double click. 
Add the package to the top-right box on the dependencies tab. 
</p>

<p class="dialogue">We're also going to want to use our api, so we'll add that dependency now too.
</p>

<p class="instruction">Click Add, enter *word* and select the wordassociation package.
Switch tabs to show the change which has been made to the manifest.
Then navigate back to the AssociateWord class
</p>

<p class="dialogue">We need to fill in some html boilerplate.
</p>

<p class="code">        PrintWriter out = response.getWriter();
        out.println("&lt;html&gt;");
        out.println("&lt;/html&gt;");
</p>

<p class="dialogue">Let's add in the services we'll be using. </p>

<p class="instruction">Add the following to the beginning of the class:
</p>

<p class="code">    private WordGetterService getter;
    private AssociationRecorderService recorder;
</p>

<p class="instruction">Fill in the html to print out the random word:
</p>

<p class="code">                out.println("The word is " + getter.getRandomWord());
                out.println("&lt;/br&gt;");
</p>

<p class="dialogue">
So do you think it's going to find its dependencies in JNDI at the moment? I don't think so either, so we better put some failsafes in. 
</p>

<p class="instruction">Add guards around the getter dereference:</p>

<p class="code">            if (getter != null)
            {
</p>
and 

<p class="code">            } else 
            {
                out.println("Oh dear. Our dependencies haven't been found.");
            }
</p>

<p class="dialogue">When the user submits the form, we want to tell them what other things have 
been associated with that word. 
</p>
<p class="instruction">
Add the following content to the doPost() method:
</p>
<p class="code">                String word = request.getParameter("word");
                String association = request.getParameter("association");
                String person = request.getParameter("person");

                String previousAssociation = null;
                if (recorder != null) {
                        recorder.recordAssociation(word, association, person);
                        previousAssociation = recorder.getLastAssociation(word);
                }
                PrintWriter out = response.getWriter();
                out.println("The last person associated " + word + " with "
                                + previousAssociation);
</p>

<p class="dialogue">There are three ways we can get our services. One is the normal OSGi way of looking them up in a bundle context. Aries adds the possibility of dependency injection,
and also a JEE-integration which allows looking them up in JNDI.
Blueprint dependencies can't be injected into a servlet, because a servlet
is a JEE kind of artefact - this is the same as you get with spring, 
dependency injection doesn't work with spring.  Instead we'll look them up in JNDI. This is
the first thing we're doing which is specific to Aries. Normally you
can have a JEE bundle, or you can have an OSGi bundle, but there's not 
much integration between the two. Here Aries is providing a compatibility
layer between the servlet, which is managed by the JEE container, and 
all the great OSGi services we're going to want to use.</p>

<p class="instruction">
</p>

<p class="dialogue">This is an OSGi bundle, and InitialContext isn't shipped as an OSGi bundle, 
so we need to add Import-Package: javax.naming. We could also use @Resource here. 
</p>

<p class="instruction">Navigate back to the manifest and add a dependency
on javax.naming.
</p>

<p class="code">		try {
			getter = (WordGetterService) new InitialContext()
					.lookup("aries:services/"
							+ WordGetterService.class.getName());
			recorder = (AssociationRecorderService) new InitialContext()
					.lookup("aries:services/"
							+ AssociationRecorderService.class.getName());
		} catch (NamingException e) {
			e.printStackTrace();
		}
</p>

<p class="instruction">To export the bundle, right click and choose
Export&rarr;War file. Browse to the assembly load directory and choose
an archive name. Once the export is complete, typing ss in the OSGi
console should show the bundle. Navigating to <a href="http://localhost:8080/wordassociation.web/AssociateWord">http://localhost:8080/wordassociation.web/AssociateWord</a>
should bring up a web page that reports missing dependencies.

<h3>The persistence</h3>

<p class="instruction">Create another OSGi bundle project, and choose a JPA facet. 
</p>
<p class="instruction">Click through until prompted to choose a library.
</p>

<p class="instruction">Create a library and add geronimo-jpa_2.0_spec-1.0.jar to the library. Accept the defaults for the other parameters and finish. 
</p>

<p class="dialogue">This new project is going to implement the wordassociation
services, so We need to add a dependency on the wordassociation API. 
</p>

<p class="instruction">Navigate to the manifest, and add the package which comes up if you type *word* into the filter box.
</p>

<p class="dialogue">Note that *word* doesn't show any code from our web bundle, because we wanted to
 keep that private. 
</p>

<h4>Setting up the persistence</h4>

<h4>Entity enhancement</h4>

<p class="dialogue">If you're running in a JEE-5-application server, JPA entities will be automatically enhanced. We're just running in a little OSGi container, so we need to do that ourselves. Normally you'd use an ant task to enhance the entities, but we're running
in Eclipse, so we'll add an eclipse builder.
</p>

<p class="instruction">Right-click on the project, select Properties, choose Builders,
then New. Choose 'Program'. Move to the Location field, click the Variables button, 
and select the java_home variable you created earlier. Fill in the full path to the java executable,
as follows:</p>

<p class="field">${java_home}/jre/bin.</p>

<p class="instruction">Fill in the following for the arguments, again selecting from the variables list when
needed:</p>

<p class="field">-cp ${open_jpa_home}/openjpa-all-2.0.0.jar:${build_project}/src org.apache.openjpa.enhance.PCEnhancer ${build_files}</p>

<p class="instruction">You should see the following message in the console following each build:
</p>
<p class="field" style="color: red;">132  wordassociation.jpa  INFO   [main] openjpa.Tool - No targets were given.  Running on all classes in your persistent classes list, or all metadata files in classpath directories if you have not listed your persistent classes.  Use -help to display tool usage information.
</p>

<h4>Defining the entity</h4>

<p class="instruction">Create a new class called Association. Add 'word' and 'associated' fields. Righ
t click and choose <strong>Source&rarr;Generate getters and setters</strong>. Select both word and as
sociation, and change the insertion point to 'last member'.
</p>
<p class="code">        private String word;
        private String associated;
</p>

We will have compile errors until we map this to a persistence entity, by adding an @Entity annotation:

<p class="code">@Entity(name = "ASSOCIATION")
</p>

<p class="instruction">Add a primary key for the word field:
</p>
<p class="code">        @Id
        private String word;
</p>

   
<p class="dialogue">
Now we get a compilation error, because we have a dependency on org.apache.openjpa.enhance.
Normally we'd have to work out which jar this came from and add it to the classpath,
and if we're sharing the project adding the jar to the classpath in a portable
way is a bit of a nuisance. Instead we can just add the org.apache.openjpa.enhance package
to our dependencies.
</p>

<p class="instruction">
Navigate to the manifest and add an import-package for org.apache.openjpa.enhance.
</p>

<h4>Setting up the persistence</h4>

<p class="instruction">
Expand the newly created project, expand JPA content, and
open persistence.xml. On the general tab, add the Association
class, and make sure 'exclude unlisted classes' is selected.
Navigate to the Connection tab and fill in the following:
</p>
<p class="field">aries:services/javax.sql.DataSource/(osgi.jndi.service.name=jdbc/wordassociation
db)
</p>

<p class="dialogue">
Here we're again making use of the JNDI integration Aries provides
to point JPA at the JNDI mapping of a datasource we've defined
as an OSGi service. 
</p>

<p class="dialogue">
We want to declare the services, and we do this by creating an xml
file with the service definitions in it. 
</p>

<p class="instruction">Create a blueprint.xml by New&rarr;Other&rarr;OSGi&rarr;blueprint.xml
or right-clicking on the project and choosing <strong>OSGi&rarr;Create a new blueprint file</strong>
</p>

<p class="dialogue">
We now need to fill in some namespaces manually, to indicate that we're
not just going to be using this blueprint.xml for dependency injection -
we're going to use to get integration with our transaction and persistence 
providers so that they get injected too. We do this by adding the following namespace to our blueprint xml:
</p>

<p class="xml">xmlns:jpa="http://aries.apache.org/xmlns/jpa/v1.0.0" xmlns:tx="http://aries.apache.org/xmlns/transactions/v1.0.0"
</p>
and the following to the bean definition for the recorder service:

            <p class="xml">    &lt;jpa:context property="entityManager" unitname="wordassociation.jpa" /&gt;
</p>

<p class="dialogue">The blueprint.xml file is one of the most important
files in an Aries application. It's where we declare dependency injections,
container-managed persistence, and container-managed transactions.
It also allows us to create services declaratively. Normally an OSGi service
would be registered at runtime, by Java code, but that doesn't 
have a very enterprise feel to it. What Aries allows us to do is 
register services declaratively in XML instead.</p>

<p class="xml">	&lt;service interface="org.apache.wordassociation.AssociationRecorderService"
		ref="recorder" /&gt;
	&lt;bean class="org.apache.wordassociation.jpa.Recorder" id="recorder"&gt;
	&lt;/bean&gt;
</p>

<p class="instruction">Avoid the temptation to declare the bean inside
the service. It saves typing but doesn't work when JPA is involved. Add
in elements for the persistence and transactions to the recorder bean:</p>

<p class="xml">
	&lt;bean class="org.apache.wordassociation.jpa.Recorder" id="recorder"&gt;
		&lt;jpa:context property="entityManager" unitname="wordassociation.jpa" /&gt;
		&lt;tx:transaction method="*" value="Required" /&gt;
	&lt;/bean&gt;
</p>

<p class="instruction">The unit name should match the one defined in persistence.xml.
</p>


<h4>Defining the recorder service</h4>

<p class="instruction">Define a new class org.apache.wordassociation.jpa.Recorder which
implements the AssociationRecorderService. Use the new class wizard to fill in
stubs for the interface methods.

</p>

<p class="instruction">Create a field for the entity manager 
and right click, choose <strong>Source&rarr;Generate getters and setters</strong>
and generate a setter (but no getter).</p>

<p class="dialogue">
The cool thing here is that we didn't have to do anything to initialize the 
JPA entity manager - it gets injected for us. Now we just need to fill in
the logic to handle persisting our data.
</p>

<p class="instruction">Fill in the following contents for recordAssociation()
</p>

<p class="code">		Association found = em.find(Association.class, word);
		if (found != null) {
			found.setAssociated(association);
		} else {
			Association a = new Association();
			a.setWord(word);
			a.setAssociated(association);
			em.persist(a);
		}
</p>

<p class="code">		Association found = em.find(Association.class, word);
		if (found != null) {
			return found.getAssociated();
		} else {
			return "nothing";
		}
</p>



<h4>The word lister</h4>

<p class="dialogue">Finally, we need to provide a service which returns
words to make the associations with. We could have this service backed by
a database, but it would look pretty similar to the recorder service, so
for testing we'll just use a static list instead.</p>

<p class="instruction">Navigate back to the blueprint.xml and add
a declaration for the service.</p>

<p class="xml">
	&lt;service interface="org.apache.wordassociation.WordGetterService"&gt;
		&lt;bean class="org.apache.wordassociation.jpa.WordLister" /&gt;
	&lt;/service&gt;
	</p>

<p class="instruction">Create a WordLister class, have it implement WordGetterService in the class
creation wizard and fill in the following content around the boiler-plate. You can ask
the audience to supply the three words to keep them awake.</p>

<p class="code">public class WordLister implements WordGetterService {
	String[] words = { "computers", "Java", "coffee" };

	public WordLister() {
	}

	@Override
	public String getRandomWord() {
		return words[new Random().nextInt(3)];
	}

</p>

<h4>Exporting and testing</h4>

<p class="instruction">Export the JPA bundle to the load directory. 
Revisiting the web application URL should bring up a web application
which handles both prompting for a word association and 
telling users what previous users came up with. Making the associations
should provide another opportunity for people in the audience to 
get involved by calling out word associations.</p>

<h2>Extras</h2>

<p>For a longer demo, consider some of the following.
</p>

<h3>Application assembly</h3>

<p>If there's time, we can assemble our bundles into an application.
The free tools provide support for this. Create a new project of type OSGi Enterprise
Application, provide a name and choose Next, and then add the wordassociation bundles
to it as a contained bundles and export. 
</p>

<h3>Multiple lister services</h3>

<p>We can add a second bundle with a different lister service and show how we can switch
between the two bundles using the OSGi console.
</p>

<h2 id="troubleshooting">Common errors</h2>

<ul>
<li>Spelling 'association' 'assocation' or 'associaton' - or numerous other variants!</li>
<li>Making a dependency on the bundle instead of the package</li>
<li>Shortening package names. It's temping to use shorter package names while coding live. Doing this is risky
 because it means the canned bundles can't be swapped in to replace bundles which don't work quite right after being coded in front of an audience.
 </li>
 <li>Split packages. If shorter package names are used, a different short package name must be used for each bundle or blueprint will struggle to resolve things.</li>
<li>Forgetting build-time JPA enhancement. This leads to the following runtime error: ""This configuration disallows runtime optimization, but the following listed types were not enhanced at build time or at class load time with a javaagent".
To resolve, make sure the OpenJPA plugin is installed in eclipse and add the
 bytecode enhancer to the JPA project.</li>
 <li>Anonymous beans for JPA services. Using an anonymous bean to define the Recorder service seems sensible, but it seems that it prevents proper container management of the transactions.</li>
<li>Non-JTA data sources. Both JTA and non-JTA data sources need to be defined.</li>
<li>""nonfatal general error: org.apache.openjpa.persistence.PersistenceException: Error extracting class information from "bundleresource://43.fwk1934652240/"." This error is 
caused by forgetting the following line from the persistence.xml (also available as checkbox on the General tab):		
<p class="xml">&lt;exclude-unlisted-classes&gt;true&lt;/exclude-unlisted-classes&gt;

</p>


<li>Using the OpenJPA entity enhancement Eclipse plugin. The OpenJPA provide a plugin for Eclipse which 
automatically enhances entities, but it doesn't work very well, probably because it's
built on OpenJPA 1.2. Add your own builder or use an ant task.</li>
</ul>

<p>If importing the existing projects into an Eclipse WTP/OSGi Application Tools
installation, it's necessary to create an OpenJPA user library by navigating to <strong>Window&rarr;Preferences&rarr;Java&rarr;Build Path&rarr;User libraries</strong> and creating a new library called OpenJPA which includes the geronimo-jpa and org.apache.aries.jpa.container jars.
</p>

</body>
</html>
